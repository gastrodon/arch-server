. "$(dirname $0)/../../hosts/$(hostname)/variables"

if [[ ! $consul_version == "$(dpkg -s consul | grep -Po '(?<=Version: ).+')" ]]; then
  apt-get update
  apt-get -y install consul="$consul_version"
fi

mkdir -p /etc/consul.d
cat <<HCL > /etc/consul.d/consul.hcl
datacenter = "$consul_datacenter"
data_dir = "/opt/consul/data"
log_level = "WARN"

server = $server
client_addr = "0.0.0.0"
bind_addr = "{{ GetInterfaceIP \"ens5\" }}"
retry_join = [ "provider=aws tag_key=nomad_mode tag_value=$mode"]
$( [ "$server" = "true" ] && echo "bootstrap_expect = $bootstrap_expect" )

acl = {
  enabled = true
  default_policy = "deny"
  enable_token_persistence = true
  enable_token_replication = true
  down_policy = "extend-cache"

  tokens {
    initial_management = "$consul_token"
    agent              = "$consul_token"
  }
}

service {
  name = "consul"
}

ui_config {
  enabled = true
}

ports {
  grpc = 8502
}
HCL

systemctl enable consul
systemctl restart consul
