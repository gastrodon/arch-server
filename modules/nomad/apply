. "$(dirname $0)/../../hosts/$(hostname)/variables"

if [[ ! $nomad_version == "$(dpkg -s nomad | grep -Po '(?<=Version: ).+')" ]]; then
  apt-get update
  apt-get -y install nomad="$nomad_version"
fi

mkdir -p /etc/nomad.d
cat <<HCL > /etc/nomad.d/nomad.hcl
datacenter = "$nomad_datacenter"
data_dir   = "/opt/nomad/data"
bind_addr  = "0.0.0.0"

server {
  enabled          = $server
  bootstrap_expect = 3
  server_join {
    retry_join = [ "provider=aws tag_key=nomad_mode tag_value=$mode" ]
    retry_max      = 0
    retry_interval = "15s"
  }
}

client {
  enabled = true
  server_join {
    retry_join = [ "provider=aws tag_key=nomad_mode tag_value=$mode" ]
    retry_max      = 0
    retry_interval = "15s"
  }

  artifact {
    decompression_file_count_limit = 0
  }
}

plugin "docker" {
  config {
    allow_privileged = true
    auth {
      config = "/etc/docker-auth.json"
    }
  }
}

plugin "raw_exec" {
  config {
    enabled = true
  }
}

acl {
  enabled = true
}

telemetry {
  collection_interval = "1s"
  disable_hostname = true
  prometheus_metrics = true
  publish_allocation_metrics = true
  publish_node_metrics = true
}

consul {
  address = "127.0.0.1:8500"
  token   = "$consul_token"
}

limits {
  http_max_conns_per_client = 0
}
HCL

systemctl enable nomad
systemctl restart nomad
